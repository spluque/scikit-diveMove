
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tdr &#8212; skdiveMove 0.1.2 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skdiveMove 0.1.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">tdr</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tdr</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;TDR objects homologous to `R` package diveMove&#39;s main classes</span>

<span class="sd">The :class:`TDR` class aims to be a comprehensive class to encapsulate the</span>
<span class="sd">processing of `TDR` records from a data file.</span>

<span class="sd">This module instantiates an `R` session to interact with low-level</span>
<span class="sd">functions and methods of package `diveMove`.</span>

<span class="sd">Class &amp; Main Methods Summary</span>
<span class="sd">----------------------------</span>

<span class="sd">See `API` section for details on minor methods.</span>

<span class="sd">Calibration and phase detection</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autosummary::</span>

<span class="sd">   TDR</span>
<span class="sd">   TDR.zoc</span>
<span class="sd">   TDR.detect_wet</span>
<span class="sd">   TDR.detect_dives</span>
<span class="sd">   TDR.detect_dive_phases</span>
<span class="sd">   TDR.calibrate</span>
<span class="sd">   TDR.calibrate_speed</span>

<span class="sd">Analyses</span>
<span class="sd">~~~~~~~~</span>

<span class="sd">.. autosummary::</span>

<span class="sd">   TDR.dive_stats</span>
<span class="sd">   TDR.time_budget</span>
<span class="sd">   TDR.stamp_dives</span>

<span class="sd">Plotting</span>
<span class="sd">~~~~~~~~</span>

<span class="sd">.. autosummary::</span>

<span class="sd">   TDR.plot</span>
<span class="sd">   TDR.plot_zoc</span>
<span class="sd">   TDR.plot_phases</span>
<span class="sd">   TDR.plot_dive_model</span>

<span class="sd">API</span>
<span class="sd">---</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">skdiveMove.tdrsource</span> <span class="kn">import</span> <span class="n">TDRSource</span>
<span class="kn">from</span> <span class="nn">skdiveMove.zoc</span> <span class="kn">import</span> <span class="n">ZOC</span>
<span class="kn">from</span> <span class="nn">skdiveMove.tdrphases</span> <span class="kn">import</span> <span class="n">TDRPhases</span>
<span class="kn">import</span> <span class="nn">skdiveMove.plotting</span> <span class="k">as</span> <span class="nn">plotting</span>
<span class="kn">import</span> <span class="nn">skdiveMove.calibrate_speed</span> <span class="k">as</span> <span class="nn">speedcal</span>
<span class="kn">from</span> <span class="nn">skdiveMove.helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_var_sampling_interval</span><span class="p">,</span>
                                <span class="n">_get_dive_indices</span><span class="p">,</span> <span class="n">_add_xr_attr</span><span class="p">,</span>
                                <span class="n">_one_dive_stats</span><span class="p">,</span> <span class="n">_speed_stats</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># Add the null handler if importing as library; whatever using this library</span>
<span class="c1"># should set up logging.basicConfig() as needed</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>

<span class="c1"># Keep attributes in xarray operations</span>
<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="TDR"><a class="viewcode-back" href="../tdr.html#tdr.TDR">[docs]</a><span class="k">class</span> <span class="nc">TDR</span><span class="p">(</span><span class="n">TDRSource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class encapsulating TDR objects and processing</span>

<span class="sd">    TDR subclasses `TDRSource` to provide comprehensive TDR processing</span>
<span class="sd">    capabilities.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tdr_file : str</span>
<span class="sd">        String indicating the file where data comes from.</span>
<span class="sd">    tdr : xarray.Dataset</span>
<span class="sd">        Dataset with input data.</span>
<span class="sd">    depth_name : str</span>
<span class="sd">        Name of Dataset variable with depth measurements.</span>
<span class="sd">    has_speed : bool</span>
<span class="sd">        Whether input data include speed measurements.</span>
<span class="sd">    speed_name : str</span>
<span class="sd">        Name of Dataset variable with the speed measurements.</span>
<span class="sd">    zoc_depth : ZOC</span>
<span class="sd">        Instance to perform and store zero offset correction operations for</span>
<span class="sd">        depth.</span>
<span class="sd">    phases : TDRPhases</span>
<span class="sd">        Instance for performing wet/dry and dive phase detection.</span>
<span class="sd">    speed_calib_fit : quantreg model fit</span>
<span class="sd">        Model object fit by quantile regression for speed calibration.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Construct an instance from diveMove example dataset</span>

<span class="sd">    &gt;&gt;&gt; rstr = (&#39;system.file(file.path(&quot;data&quot;, &quot;dives.csv&quot;), &#39;</span>
<span class="sd">    ...         &#39;package=&quot;diveMove&quot;, mustWork=TRUE)&#39;)</span>
<span class="sd">    &gt;&gt;&gt; data_path = robjs.r(rstr)[0]</span>
<span class="sd">    &gt;&gt;&gt; tdrX = TDR(data_path, sep=&quot;;&quot;, compression=&quot;bz2&quot;)</span>

<span class="sd">    For convenience, the above operation is wrapped in the function</span>
<span class="sd">    `get_diveMove_sample_data`.</span>

<span class="sd">    Plot the `TDR` object</span>

<span class="sd">    &gt;&gt;&gt; tdrX.plot()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up attributes for TDR objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TDRSource</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Attributes to be set from other methods: method used, corrected</span>
        <span class="c1"># depth, filtered depth when method=&quot;filter&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span> <span class="o">=</span> <span class="n">ZOC</span><span class="p">()</span>
        <span class="c1"># Speed calibration fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_calib_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Wet phase activity identification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span> <span class="o">=</span> <span class="n">TDRPhases</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr</span>
        <span class="n">xdf</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">objcls</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Time-Depth Recorder data -- Class </span><span class="si">{}</span><span class="s2"> object</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Source File&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr_file</span><span class="p">)</span>
        <span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sampling interval&quot;</span><span class="p">,</span>
                       <span class="n">get_var_sampling_interval</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">])))</span>
        <span class="n">nsamples</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Number of Samples&quot;</span><span class="p">,</span>
                                          <span class="n">xdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">beg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sampling Begins&quot;</span><span class="p">,</span>
                                     <span class="n">xdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sampling Ends&quot;</span><span class="p">,</span>
                                     <span class="n">xdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Total duration&quot;</span><span class="p">,</span>
                                     <span class="n">xdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">drange</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> [</span><span class="si">{1}</span><span class="s2">,</span><span class="si">{2}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Measured depth range&quot;</span><span class="p">,</span>
                                              <span class="n">xdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                              <span class="n">xdf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">others</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Other variables&quot;</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xdf</span><span class="o">.</span><span class="n">columns</span>
                                         <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">])</span>
        <span class="n">zocm</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&lt;20}</span><span class="s2">: </span><span class="se">\&#39;</span><span class="si">{1}</span><span class="se">\&#39;\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;ZOC method&quot;</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">attr_list</span> <span class="o">=</span> <span class="s2">&quot;Attributes:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">attr_list</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;35}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">attr_list</span> <span class="o">=</span> <span class="n">attr_list</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">objcls</span> <span class="o">+</span> <span class="n">src</span> <span class="o">+</span> <span class="n">itv</span> <span class="o">+</span> <span class="n">nsamples</span> <span class="o">+</span> <span class="n">beg</span> <span class="o">+</span> <span class="n">end</span> <span class="o">+</span> <span class="n">dur</span> <span class="o">+</span> <span class="n">drange</span> <span class="o">+</span>
               <span class="n">others</span> <span class="o">+</span> <span class="n">zocm</span> <span class="o">+</span> <span class="n">attr_list</span><span class="p">)</span>

<div class="viewcode-block" id="TDR.zoc"><a class="viewcode-back" href="../tdr.html#tdr.TDR.zoc">[docs]</a>    <span class="k">def</span> <span class="nf">zoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zero offset correction</span>

<span class="sd">        Set the ``zoc_depth`` attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : {&quot;filter&quot;, &quot;offset&quot;}</span>
<span class="sd">            Name of method to use for zero offset correction.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            - methods &#39;filter&#39;: (&#39;k&#39;, &#39;probs&#39;, &#39;depth_bounds&#39; (defaults to</span>
<span class="sd">              range), &#39;na_rm&#39; (defaults to True)).</span>
<span class="sd">            - method &#39;offset&#39;: (&#39;offset&#39;).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        More details in diveMove&#39;s ``calibrateDepth`` function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;offset&quot; method</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>

<span class="sd">        Using the &quot;filter&quot; method</span>

<span class="sd">        &gt;&gt;&gt; # Window lengths and probabilities</span>
<span class="sd">        &gt;&gt;&gt; DB = [-2, 5]</span>
<span class="sd">        &gt;&gt;&gt; K = [3, 5760]</span>
<span class="sd">        &gt;&gt;&gt; P = [0.5, 0.02]</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(k=K, probs=P, depth_bounds=DB)</span>

<span class="sd">        Plot the filters that were applied</span>

<span class="sd">        &gt;&gt;&gt; tdrX.plot_zoc(ylim=[-1, 10])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;measured&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished ZOC&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.detect_wet"><a class="viewcode-back" href="../tdr.html#tdr.TDR.detect_wet">[docs]</a>    <span class="k">def</span> <span class="nf">detect_wet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect wet/dry activity phases</span>

<span class="sd">        Set the ``wet_dry`` attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs : Keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.detect_wet`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See details for arguments in diveMove&#39;s ``calibrateDepth``.  Unlike</span>
<span class="sd">        `diveMove`, the beginning/ending times for each phase are not</span>
<span class="sd">        stored with the class instance, as this information can be</span>
<span class="sd">        retrieved via the `.time_budget` method.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;offset&quot; method for convenience</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>

<span class="sd">        Detect wet/dry phases</span>

<span class="sd">        &gt;&gt;&gt; tdrX.detect_wet()</span>

<span class="sd">        Access the &quot;phases&quot; and &quot;dry_thr&quot; attributes</span>

<span class="sd">        &gt;&gt;&gt; tdrX.get_wet_activity(&quot;phases&quot;)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.get_wet_activity(&quot;dry_thr&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">detect_wet</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished detecting wet/dry periods&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.detect_dives"><a class="viewcode-back" href="../tdr.html#tdr.TDR.detect_dives">[docs]</a>    <span class="k">def</span> <span class="nf">detect_dives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dive_thr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify dive events</span>

<span class="sd">        Set the ``dives`` attribute&#39;s &quot;row_ids&quot; dictionary element, and</span>
<span class="sd">        update the ``wet_act`` attribute&#39;s &quot;phases&quot; dictionary element.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dry_thr : float</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.detect_dives`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See details for arguments in diveMove&#39;s ``calibrateDepth``.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;offset&quot; method for convenience</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>

<span class="sd">        Detect wet/dry phases and dives with 3 m threshold</span>

<span class="sd">        &gt;&gt;&gt; tdrX.detect_wet()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.detect_dives(3)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">detect_dives</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">dive_thr</span><span class="o">=</span><span class="n">dive_thr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished detecting dives&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.detect_dive_phases"><a class="viewcode-back" href="../tdr.html#tdr.TDR.detect_dive_phases">[docs]</a>    <span class="k">def</span> <span class="nf">detect_dive_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect dive phases</span>

<span class="sd">        Complete filling the ``dives`` attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.detect_dive_phases`</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See details for arguments in diveMove&#39;s ``calibrateDepth``.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;offset&quot; method for convenience</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>

<span class="sd">        Detect wet/dry phases and dives with 3 m threshold</span>

<span class="sd">        &gt;&gt;&gt; tdrX.detect_wet()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.detect_dives(3)</span>

<span class="sd">        Detect dive phases using the &quot;unimodal&quot; method and selected</span>
<span class="sd">        parameters</span>

<span class="sd">        &gt;&gt;&gt; tdrX.detect_dive_phases(&quot;unimodal&quot;, descent_crit_q=0.01,</span>
<span class="sd">        ...                         ascent_crit_q=0, knot_factor=20)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">detect_dive_phases</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished detecting dive phases&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.calibrate"><a class="viewcode-back" href="../tdr.html#tdr.TDR.calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoc_method</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="n">dry_thr</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">wet_cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">wet_thr</span><span class="o">=</span><span class="mi">3610</span><span class="p">,</span> <span class="n">interp_wet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dive_thr</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                  <span class="n">dive_model</span><span class="o">=</span><span class="s2">&quot;unimodal&quot;</span><span class="p">,</span> <span class="n">smooth_par</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">knot_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                  <span class="n">descent_crit_q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascent_crit_q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calibrate TDR object</span>

<span class="sd">        Convenience method to set all instance attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        zoc_method : {&quot;filter&quot;, &quot;offset&quot;}, optional</span>
<span class="sd">            Name of method to use for zero offset correction.</span>
<span class="sd">        dry_thr : float, optional</span>
<span class="sd">        wet_cond : bool mask, optional</span>
<span class="sd">        wet_thr : float, optional</span>
<span class="sd">        dive_thr : float, optional</span>
<span class="sd">        dive_model : {&quot;unimodal&quot;, &quot;smooth.spline&quot;}, optional</span>
<span class="sd">        smooth_par : float, optional</span>
<span class="sd">        knot_factor : int, optional</span>
<span class="sd">        descent_crit_q, ascent_crit_q : float, optional</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :meth:`TDR.zoc` method:</span>

<span class="sd">            * method &#39;filter&#39;: (&#39;k&#39;, &#39;probs&#39;, &#39;depth_bounds&#39; (defaults to</span>
<span class="sd">              range), &#39;na_rm&#39; (defaults to True)).</span>
<span class="sd">            * method &#39;offset&#39;: (&#39;offset&#39;).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method is homologous to diveMove&#39;s ``calibrateDepth`` function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;filter&quot; method</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>

<span class="sd">        &gt;&gt;&gt; # Window lengths and probabilities</span>
<span class="sd">        &gt;&gt;&gt; DB = [-2, 5]</span>
<span class="sd">        &gt;&gt;&gt; K = [3, 5760]</span>
<span class="sd">        &gt;&gt;&gt; P = [0.5, 0.02]</span>

<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;filter&quot;,</span>
<span class="sd">        ... k=K, probs=P, depth_bounds=DB, descent_crit_q=0.01,</span>
<span class="sd">        ... knot_factor=20)</span>

<span class="sd">        Plot dive phases</span>

<span class="sd">        &gt;&gt;&gt; tdrX.plot_phases()</span>

<span class="sd">        Plot dive model for a dive</span>

<span class="sd">        &gt;&gt;&gt; tdrX.plot_dive_model(40)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoc</span><span class="p">(</span><span class="n">zoc_method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_wet</span><span class="p">(</span><span class="n">dry_thr</span><span class="o">=</span><span class="n">dry_thr</span><span class="p">,</span> <span class="n">wet_cond</span><span class="o">=</span><span class="n">wet_cond</span><span class="p">,</span> <span class="n">wet_thr</span><span class="o">=</span><span class="n">wet_thr</span><span class="p">,</span>
                        <span class="n">interp_wet</span><span class="o">=</span><span class="n">interp_wet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_dives</span><span class="p">(</span><span class="n">dive_thr</span><span class="o">=</span><span class="n">dive_thr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_dive_phases</span><span class="p">(</span><span class="n">dive_model</span><span class="o">=</span><span class="n">dive_model</span><span class="p">,</span>
                                <span class="n">smooth_par</span><span class="o">=</span><span class="n">smooth_par</span><span class="p">,</span>
                                <span class="n">knot_factor</span><span class="o">=</span><span class="n">knot_factor</span><span class="p">,</span>
                                <span class="n">descent_crit_q</span><span class="o">=</span><span class="n">descent_crit_q</span><span class="p">,</span>
                                <span class="n">ascent_crit_q</span><span class="o">=</span><span class="n">ascent_crit_q</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.calibrate_speed"><a class="viewcode-back" href="../tdr.html#tdr.TDR.calibrate_speed">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">contour_level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bad</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">save_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calibrate speed measurements</span>

<span class="sd">        Set the `speed_calib_fit` attribute</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tau : float, optional</span>
<span class="sd">            Quantile on which to regress speed on rate of depth change.</span>
<span class="sd">        contour_level : float, optional</span>
<span class="sd">            The mesh obtained from the bivariate kernel density estimation</span>
<span class="sd">            corresponding to this contour will be used for the quantile</span>
<span class="sd">            regression to define the calibration line.</span>
<span class="sd">        z : float, optional</span>
<span class="sd">            Only changes in depth larger than this value will be used for</span>
<span class="sd">            calibration.</span>
<span class="sd">        bad : array_like, optional</span>
<span class="sd">            Two-element `array_like` indicating that only rates of depth</span>
<span class="sd">            change and speed greater than the given value should be used</span>
<span class="sd">            for calibration, respectively.</span>
<span class="sd">        save_fig : bool, optional</span>
<span class="sd">            Whether to save the plot.</span>
<span class="sd">        fname : str, optional</span>
<span class="sd">            A path to save plot.  Ignored if ``save_fig=False``.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :func:`calibrate_speed.calibrate`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : 3-tuple</span>
<span class="sd">            The quantile regression fit object, `matplotlib.pyplot` `Axes`</span>
<span class="sd">            and `Figures` instances.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate_speed(z=2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
        <span class="n">ddiffs</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ddepth</span> <span class="o">=</span> <span class="n">ddiffs</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">rddepth</span> <span class="o">=</span> <span class="n">ddepth</span> <span class="o">/</span> <span class="n">ddiffs</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">curspeed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_speed</span><span class="p">(</span><span class="s2">&quot;measured&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">ddepth</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rddepth</span> <span class="o">&gt;</span> <span class="n">bad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">curspeed</span> <span class="o">&gt;</span> <span class="n">bad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rddepth</span> <span class="o">=</span> <span class="n">rddepth</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
        <span class="n">curspeed</span> <span class="o">=</span> <span class="n">curspeed</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="n">kde_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">rddepth</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;depth_rate&quot;</span><span class="p">),</span>
                              <span class="n">curspeed</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">qfit</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">speedcal</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">kde_data</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                                           <span class="n">contour_level</span><span class="o">=</span><span class="n">contour_level</span><span class="p">,</span>
                                           <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">bad</span><span class="o">=</span><span class="n">bad</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_calib_fit</span> <span class="o">=</span> <span class="n">qfit</span>

        <span class="k">if</span> <span class="n">save_fig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished calibrating speed&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">qfit</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.dive_stats"><a class="viewcode-back" href="../tdr.html#tdr.TDR.dive_stats">[docs]</a>    <span class="k">def</span> <span class="nf">dive_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth_deriv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate dive statistics in `TDR` records</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        depth_deriv : bool, optional</span>
<span class="sd">            Whether to compute depth derivative statistics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method homologous to diveMove&#39;s `diveStats` function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        ZOC using the &quot;filter&quot; method</span>

<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>

<span class="sd">        &gt;&gt;&gt; # Window lengths and probabilities</span>
<span class="sd">        &gt;&gt;&gt; DB = [-2, 5]</span>
<span class="sd">        &gt;&gt;&gt; K = [3, 5760]</span>
<span class="sd">        &gt;&gt;&gt; P = [0.5, 0.02]</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;filter&quot;,</span>
<span class="sd">        ...                k=K, probs=P, depth_bounds=DB,</span>
<span class="sd">        ...                descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.dive_stats()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phases_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;row_ids&quot;</span><span class="p">)</span>

        <span class="c1"># calib_speed=False if no fit object</span>
        <span class="n">tdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tdr</span><span class="p">(</span><span class="n">calib_depth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">calib_speed</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_calib_fit</span><span class="p">))</span>

        <span class="n">intvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_var_sampling_interval</span><span class="p">(</span><span class="n">tdr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">])</span>
                 <span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="n">tdr</span> <span class="o">=</span> <span class="n">tdr</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="n">dive_ids</span> <span class="o">=</span> <span class="n">phases_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;dive_id&quot;</span><span class="p">]</span>
        <span class="n">postdive_ids</span> <span class="o">=</span> <span class="n">phases_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;postdive_id&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">dive_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dive_ids</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">postdive_ids</span><span class="p">)</span>
        <span class="n">okpd</span> <span class="o">=</span> <span class="p">(</span><span class="n">postdive_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">postdive_ids</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dive_ids</span><span class="p">)</span>
        <span class="n">postdive_ids</span> <span class="o">=</span> <span class="n">postdive_ids</span><span class="p">[</span><span class="n">okpd</span><span class="p">]</span>

        <span class="n">postdive_dur</span> <span class="o">=</span> <span class="p">(</span><span class="n">postdive_ids</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;postdive_id&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">tdrf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">phases_df</span><span class="p">[[</span><span class="s2">&quot;dive_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dive_phase&quot;</span><span class="p">]][</span><span class="n">ok</span><span class="p">],</span>
                           <span class="n">tdr</span><span class="p">[</span><span class="n">ok</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>

        <span class="c1"># Ugly hack to re-order columns for `diveMove` convention</span>
        <span class="n">names0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dive_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dive_phase&quot;</span><span class="p">,</span> <span class="s2">&quot;date_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span><span class="p">]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">tdrf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_speed</span><span class="p">:</span>
            <span class="n">names0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_name</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">names0</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">names0</span><span class="p">))</span>
        <span class="n">tdrf</span> <span class="o">=</span> <span class="n">tdrf</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">tdrf_grp</span> <span class="o">=</span> <span class="n">tdrf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;dive_id&quot;</span><span class="p">)</span>

        <span class="n">ones_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">tdrf_grp</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_one_dive_stats</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">intvl</span><span class="p">,</span>
                                  <span class="n">has_speed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_speed</span><span class="p">)</span>
            <span class="c1"># Rename to match dive number</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">depth_deriv</span><span class="p">:</span>
                <span class="n">deriv_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">_get_dive_deriv_stats</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">res</span><span class="p">,</span> <span class="n">deriv_stats</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ones_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="n">ones_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ones_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ones_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">dive_ids</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ones_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;dive_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ones_df</span><span class="p">[</span><span class="s2">&quot;postdive_dur&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">postdive_dur</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span>

        <span class="c1"># For postdive total distance and mean speed (if available)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_speed</span><span class="p">:</span>
            <span class="n">speed_postd</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">speed_name</span><span class="p">][</span><span class="n">okpd</span><span class="p">]</span>
                           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">postdive_ids</span><span class="p">))</span>
            <span class="n">pd_speed_ll</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">speed_postd</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">_speed_stats</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
                <span class="n">onames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;postdive_tdist&quot;</span><span class="p">,</span> <span class="s2">&quot;postdive_mean_speed&quot;</span><span class="p">]</span>
                <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">onames</span><span class="p">,</span>
                                      <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="n">pd_speed_ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_df</span><span class="p">)</span>
            <span class="n">pd_speed_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pd_speed_ll</span><span class="p">)</span>
            <span class="n">ones_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">ones_df</span><span class="p">,</span> <span class="n">pd_speed_stats</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">ones_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.plot"><a class="viewcode-back" href="../tdr.html#tdr.TDR.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concur_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concur_var_titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot TDR object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        concur_vars : str or list, optional</span>
<span class="sd">            String or list of strings with names of columns in input to</span>
<span class="sd">            select additional data to plot.</span>
<span class="sd">        concur_var_titles : str or list, optional</span>
<span class="sd">            String or list of strings with y-axis labels for `concur_vars`.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Arguments passed to plotting function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            ``matplotlib.pyplot`` Figure and Axes instances.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.plot(xlim=[&quot;2002-01-05 21:00:00&quot;, &quot;2002-01-06 04:10:00&quot;],</span>
<span class="sd">        ...           depth_lim=[95, -1])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;measured&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ylab_depth&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ylab_depth</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                                  <span class="n">depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]))</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ylab_depth</span><span class="o">=</span><span class="n">ylab_depth</span><span class="p">)</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">concur_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_tdr</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">concur_var_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ccvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr</span><span class="p">[</span><span class="n">concur_vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_tdr</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">concur_vars</span><span class="o">=</span><span class="n">ccvars</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ccvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr</span><span class="p">[</span><span class="n">concur_vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">ccvars_title</span> <span class="o">=</span> <span class="n">concur_var_titles</span>  <span class="c1"># just to shorten</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_tdr</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span>
                                        <span class="n">concur_vars</span><span class="o">=</span><span class="n">ccvars</span><span class="p">,</span>
                                        <span class="n">concur_var_titles</span><span class="o">=</span><span class="n">ccvars_title</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.plot_zoc"><a class="viewcode-back" href="../tdr.html#tdr.TDR.plot_zoc">[docs]</a>    <span class="k">def</span> <span class="nf">plot_zoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot zero offset correction filters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xlim, ylim : 2-tuple/list, optional</span>
<span class="sd">            Minimum and maximum limits for ``x``- and ``y``-axis,</span>
<span class="sd">            respectively.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to `matplotlib.pyplot.subplots`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            `matplotlib.pyplot` Figure and Axes instances.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.zoc(&quot;offset&quot;, offset=3)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.plot_zoc()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zoc_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span><span class="o">.</span><span class="n">method</span>
        <span class="n">depth_msrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;measured&quot;</span><span class="p">)</span>
        <span class="n">ylab</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depth_msrd</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">],</span>
                        <span class="n">depth_msrd</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">zoc_method</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span>
            <span class="n">zoc_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span><span class="o">.</span><span class="n">filters</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth_msrd</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;ylab&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ylab</span><span class="o">=</span><span class="n">ylab</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">plotting</span>
                       <span class="o">.</span><span class="n">_plot_zoc_filters</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">zoc_filters</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">zoc_method</span> <span class="o">==</span> <span class="s2">&quot;offset&quot;</span><span class="p">:</span>
            <span class="n">depth_msrd</span> <span class="o">=</span> <span class="n">depth_msrd</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="n">depth_zoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">depth_msrd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;measured&quot;</span><span class="p">)</span>
            <span class="n">depth_zoc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.plot_phases"><a class="viewcode-back" href="../tdr.html#tdr.TDR.plot_phases">[docs]</a>    <span class="k">def</span> <span class="nf">plot_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diveNo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concur_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">concur_var_titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot major phases found on the object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        diveNo : array_like, optional</span>
<span class="sd">            List of dive numbers (1-based) to plot.</span>
<span class="sd">        concur_vars : str or list, optional</span>
<span class="sd">            String or list of strings with names of columns in input to</span>
<span class="sd">            select additional data to plot.</span>
<span class="sd">        concur_var_titles : str or list, optional</span>
<span class="sd">            String or list of strings with y-axis labels for `concur_vars`.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Arguments passed to plotting function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            `matplotlib.pyplot` Figure and Axes instances.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;offset&quot;,</span>
<span class="sd">        ...                offset=3, descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.plot_phases(list(range(250, 300)), surface=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;row_ids&quot;</span><span class="p">)</span>
        <span class="n">dive_ids</span> <span class="o">=</span> <span class="n">row_ids</span><span class="p">[</span><span class="s2">&quot;dive_id&quot;</span><span class="p">]</span>
        <span class="n">dive_ids_uniq</span> <span class="o">=</span> <span class="n">dive_ids</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">postdive_ids</span> <span class="o">=</span> <span class="n">row_ids</span><span class="p">[</span><span class="s2">&quot;postdive_id&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">diveNo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diveNo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_ids</span><span class="p">[</span><span class="s2">&quot;dive_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diveNo</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diveNo</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dive_ids_uniq</span><span class="p">]</span>

        <span class="n">depth_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>  <span class="c1"># DataFrame</span>

        <span class="k">if</span> <span class="n">concur_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dives_all</span> <span class="o">=</span> <span class="n">depth_all</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">concur_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">concur_vars</span><span class="p">]</span>
            <span class="n">dives_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">depth_all</span><span class="p">,</span> <span class="n">concur_df</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">isin_dive_ids</span> <span class="o">=</span> <span class="n">dive_ids</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">diveNo</span><span class="p">)</span>
        <span class="n">isin_postdive_ids</span> <span class="o">=</span> <span class="n">postdive_ids</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">diveNo</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">surface</span><span class="p">:</span>
            <span class="n">isin</span> <span class="o">=</span> <span class="n">isin_dive_ids</span> <span class="o">|</span> <span class="n">isin_postdive_ids</span>
            <span class="n">dives_in</span> <span class="o">=</span> <span class="n">dives_all</span><span class="p">[</span><span class="n">isin</span><span class="p">]</span>
            <span class="n">sfce0_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">postdive_ids</span><span class="p">[</span><span class="n">postdive_ids</span> <span class="o">==</span> <span class="n">diveNo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                         <span class="o">.</span><span class="n">last_valid_index</span><span class="p">())</span>
            <span class="n">dives_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">dives_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">sfce0_idx</span><span class="p">]],</span> <span class="n">dives_in</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">details_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">row_ids</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">sfce0_idx</span><span class="p">]],</span> <span class="n">row_ids</span><span class="p">[</span><span class="n">isin</span><span class="p">]),</span>
                                   <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_ok</span> <span class="o">=</span> <span class="n">_get_dive_indices</span><span class="p">(</span><span class="n">dive_ids</span><span class="p">,</span> <span class="n">diveNo</span><span class="p">)</span>
            <span class="n">dives_df</span> <span class="o">=</span> <span class="n">dives_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_ok</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">details_df</span> <span class="o">=</span> <span class="n">row_ids</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_ok</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">wet_dry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_budget</span><span class="p">(</span><span class="n">ignore_z</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_du</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">drys</span> <span class="o">=</span> <span class="n">wet_dry</span><span class="p">[</span><span class="n">wet_dry</span><span class="p">[</span><span class="s2">&quot;phase_label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">][[</span><span class="s2">&quot;beg&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">drys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">dry_time</span> <span class="o">=</span> <span class="n">drys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dry_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">concur_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">plotting</span>
                       <span class="o">.</span><span class="n">plot_tdr</span><span class="p">(</span><span class="n">dives_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                 <span class="n">phase_cat</span><span class="o">=</span><span class="n">details_df</span><span class="p">[</span><span class="s2">&quot;dive_phase&quot;</span><span class="p">],</span>
                                 <span class="n">dry_time</span><span class="o">=</span><span class="n">dry_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">plotting</span>
                       <span class="o">.</span><span class="n">plot_tdr</span><span class="p">(</span><span class="n">dives_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                 <span class="n">concur_vars</span><span class="o">=</span><span class="n">dives_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span>
                                 <span class="n">concur_var_titles</span><span class="o">=</span><span class="n">concur_var_titles</span><span class="p">,</span>
                                 <span class="n">phase_cat</span><span class="o">=</span><span class="n">details_df</span><span class="p">[</span><span class="s2">&quot;dive_phase&quot;</span><span class="p">],</span>
                                 <span class="n">dry_time</span><span class="o">=</span><span class="n">dry_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.plot_dive_model"><a class="viewcode-back" href="../tdr.html#tdr.TDR.plot_dive_model">[docs]</a>    <span class="k">def</span> <span class="nf">plot_dive_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diveNo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot dive model for selected dive</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        diveNo : array_like, optional</span>
<span class="sd">            List of dive numbers (1-based) to plot.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Arguments passed to plotting function.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;offset&quot;,</span>
<span class="sd">        ...                offset=3, descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.plot_dive_model(diveNo=20, figsize=(10, 10))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dive_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;row_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;dive_id&quot;</span><span class="p">)</span>
        <span class="n">crit_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;crit_vals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diveNo</span><span class="p">]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">_get_dive_indices</span><span class="p">(</span><span class="n">dive_ids</span><span class="p">,</span> <span class="n">diveNo</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
        <span class="n">depth_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">_get_dive_spline_slot</span><span class="p">(</span><span class="n">diveNo</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
        <span class="n">depth_deriv</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;spline_derivs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diveNo</span><span class="p">])</span>

        <span class="c1"># Index with time stamp</span>
        <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">depth_s_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">periods</span><span class="o">=</span><span class="n">depth_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">tz</span><span class="o">=</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="n">depth_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">depth_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">depth_s_idx</span><span class="p">)</span>
            <span class="n">dderiv_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">periods</span><span class="o">=</span><span class="n">depth_deriv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">tz</span><span class="o">=</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="c1"># Extract only the series and index with time stamp</span>
            <span class="n">depth_deriv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">depth_deriv</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                    <span class="n">index</span><span class="o">=</span><span class="n">dderiv_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">depth_s</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">depth_s</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1"># Extract only the series and index with time stamp</span>
            <span class="n">depth_deriv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">depth_deriv</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                    <span class="n">index</span><span class="o">=</span><span class="n">depth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">depth_deriv</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Force integer again as `loc` coerced to float above</span>
        <span class="n">d_crit</span> <span class="o">=</span> <span class="n">crit_vals</span><span class="p">[</span><span class="s2">&quot;descent_crit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">a_crit</span> <span class="o">=</span> <span class="n">crit_vals</span><span class="p">[</span><span class="s2">&quot;ascent_crit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">d_crit_rate</span> <span class="o">=</span> <span class="n">crit_vals</span><span class="p">[</span><span class="s2">&quot;descent_crit_rate&quot;</span><span class="p">]</span>
        <span class="n">a_crit_rate</span> <span class="o">=</span> <span class="n">crit_vals</span><span class="p">[</span><span class="s2">&quot;ascent_crit_rate&quot;</span><span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Dive: </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diveNo</span><span class="p">)</span>
        <span class="n">plotting</span><span class="o">.</span><span class="n">plot_dive_model</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">depth_s</span><span class="o">=</span><span class="n">depth_s</span><span class="p">,</span>
                                 <span class="n">depth_deriv</span><span class="o">=</span><span class="n">depth_deriv</span><span class="p">,</span>
                                 <span class="n">d_crit</span><span class="o">=</span><span class="n">d_crit</span><span class="p">,</span> <span class="n">a_crit</span><span class="o">=</span><span class="n">a_crit</span><span class="p">,</span>
                                 <span class="n">d_crit_rate</span><span class="o">=</span><span class="n">d_crit_rate</span><span class="p">,</span>
                                 <span class="n">a_crit_rate</span><span class="o">=</span><span class="n">a_crit_rate</span><span class="p">,</span>
                                 <span class="n">leg_title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.get_depth"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_depth">[docs]</a>    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;measured&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve depth records</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kind : {&quot;measured&quot;, &quot;zoc&quot;}</span>
<span class="sd">            Which depth to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;measured&quot;</span><span class="p">,</span> <span class="s2">&quot;zoc&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">kinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">odepth</span> <span class="o">=</span> <span class="n">TDRSource</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">kinds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">odepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoc_depth</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">odepth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ZOC depth not available.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;kind must be one of: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kinds</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">odepth</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.get_speed"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_speed">[docs]</a>    <span class="k">def</span> <span class="nf">get_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;measured&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve speed records</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kind : {&quot;measured&quot;, &quot;calibrated&quot;}</span>
<span class="sd">            Which speed to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;measured&quot;</span><span class="p">,</span> <span class="s2">&quot;calibrated&quot;</span><span class="p">]</span>
        <span class="n">ispeed</span> <span class="o">=</span> <span class="n">TDRSource</span><span class="o">.</span><span class="n">get_speed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">kinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ospeed</span> <span class="o">=</span> <span class="n">ispeed</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">kinds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">qfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_calib_fit</span>
            <span class="k">if</span> <span class="n">qfit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Calibrated speed not available.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="n">qfit</span><span class="o">.</span><span class="n">params</span>
                <span class="n">coef_a</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coef_b</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">ospeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">ispeed</span> <span class="o">-</span> <span class="n">coef_a</span><span class="p">)</span> <span class="o">/</span> <span class="n">coef_b</span>
            <span class="n">_add_xr_attr</span><span class="p">(</span><span class="n">ospeed</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="s2">&quot;speed_calib_fit&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;kind must be one of: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kinds</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">ospeed</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.get_wet_activity"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_wet_activity">[docs]</a>    <span class="k">def</span> <span class="nf">get_wet_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve wet/dry activity DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">get_wet_activity</span><span class="p">())</span></div>

<div class="viewcode-block" id="TDR.get_dives_details"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_dives_details">[docs]</a>    <span class="k">def</span> <span class="nf">get_dives_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve wet/dry activity DataFrame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        *args, **kwargs : arguments and keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.get_dives_details`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="TDR.get_dive_deriv"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_dive_deriv">[docs]</a>    <span class="k">def</span> <span class="nf">get_dive_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve depth spline derivative for a given dive</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args : arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.get_dive_deriv`</span>
<span class="sd">        **kwargs : keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.get_dive_deriv`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">get_dive_deriv</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="TDR.get_phases_params"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_phases_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_phases_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve parameters used for identification of phases</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : {&#39;wet_dry&#39;, &#39;dives&#39;}</span>
<span class="sd">            Name of type of parameters to retrieve.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">key</span><span class="p">))</span></div>

<div class="viewcode-block" id="TDR.time_budget"><a class="viewcode-back" href="../tdr.html#tdr.TDR.time_budget">[docs]</a>    <span class="k">def</span> <span class="nf">time_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summary of wet/dry activities at the broadest scale</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.time_budget`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : pandas.DataFrame</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;offset&quot;,</span>
<span class="sd">        ...                offset=3, descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.time_budget(ignore_z=True, ignore_du=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">time_budget</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="TDR.stamp_dives"><a class="viewcode-back" href="../tdr.html#tdr.TDR.stamp_dives">[docs]</a>    <span class="k">def</span> <span class="nf">stamp_dives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify the wet/dry activity phase corresponding to each dive</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :meth:`~tdrphases.TDRPhases.stamp_dives`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : pandas.DataFrame</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;offset&quot;,</span>
<span class="sd">        ...                offset=3, descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.stamp_dives(ignore_z=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">stamp_dives</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="TDR.get_tdr"><a class="viewcode-back" href="../tdr.html#tdr.TDR.get_tdr">[docs]</a>    <span class="k">def</span> <span class="nf">get_tdr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calib_depth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calib_speed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of tdr Dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calib_depth : bool, optional</span>
<span class="sd">            Whether to return calibrated depth measurements.</span>
<span class="sd">        calib_speed : bool, optional</span>
<span class="sd">            Whether to return calibrated speed measurements.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">calib_depth</span><span class="p">:</span>
            <span class="n">depth_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_name</span>
            <span class="n">depth_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="s2">&quot;zoc&quot;</span><span class="p">)</span>
            <span class="n">tdr</span><span class="p">[</span><span class="n">depth_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth_cal</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_speed</span> <span class="ow">and</span> <span class="n">calib_speed</span><span class="p">:</span>
            <span class="n">speed_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_name</span>
            <span class="n">speed_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_speed</span><span class="p">(</span><span class="s2">&quot;calibrated&quot;</span><span class="p">)</span>
            <span class="n">tdr</span><span class="p">[</span><span class="n">speed_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed_cal</span>

        <span class="k">return</span><span class="p">(</span><span class="n">tdr</span><span class="p">)</span></div>

<div class="viewcode-block" id="TDR.extract_dive"><a class="viewcode-back" href="../tdr.html#tdr.TDR.extract_dive">[docs]</a>    <span class="k">def</span> <span class="nf">extract_dive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diveNo</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract TDR data corresponding to a particular set of dives</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        diveNo : array_like, optional</span>
<span class="sd">            List of dive numbers (1-based) to plot.</span>
<span class="sd">        **kwargs : optional keyword arguments</span>
<span class="sd">            Passed to :meth:`get_tdr`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from skdiveMove.tests import diveMove2skd</span>
<span class="sd">        &gt;&gt;&gt; tdrX = diveMove2skd()</span>
<span class="sd">        &gt;&gt;&gt; tdrX.calibrate(dive_thr=3, zoc_method=&quot;offset&quot;,</span>
<span class="sd">        ...                offset=3, descent_crit_q=0.01, knot_factor=20)</span>
<span class="sd">        &gt;&gt;&gt; tdrX.extract_dive(diveNo=20)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dive_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dives_details</span><span class="p">(</span><span class="s2">&quot;row_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;dive_id&quot;</span><span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">_get_dive_indices</span><span class="p">(</span><span class="n">dive_ids</span><span class="p">,</span> <span class="n">diveNo</span><span class="p">)</span>
        <span class="n">tdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tdr</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tdr_i</span> <span class="o">=</span> <span class="n">tdr</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">date_time</span><span class="o">=</span><span class="n">idxs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">tdr_i</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Set up info level logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="n">ifile</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;tests/data/ag_mk7_2002_022.nc&quot;</span>

    <span class="c1"># tdrX = TDRSource(ifile, has_speed=True)</span>
    <span class="c1"># print(tdrX)</span>

    <span class="c1"># xx = ZOC()</span>
    <span class="c1"># xx.offset_depth(tdrX.get_depth(), 3)</span>
    <span class="c1"># xx(tdrX.get_depth(), &quot;offset&quot;, offset=3)</span>

    <span class="n">DB</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5760</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">]</span>
    <span class="c1"># xx(tdrX.get_depth(), &quot;filter&quot;, k=K, probs=P, depth_bounds=DB)</span>

    <span class="n">tdrX</span> <span class="o">=</span> <span class="n">TDR</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">has_speed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># tdrX.zoc(method=&quot;filter&quot;, k=K, probs=P, depth_bounds=DB)</span>

    <span class="n">tdrX</span><span class="o">.</span><span class="n">zoc</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Compare n dives detected</span>
    <span class="n">tdrX</span><span class="o">.</span><span class="n">detect_wet</span><span class="p">()</span>
    <span class="n">tdrX</span><span class="o">.</span><span class="n">detect_dives</span><span class="p">(</span><span class="n">dive_thr</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">tdrX</span><span class="o">.</span><span class="n">detect_dive_phases</span><span class="p">(</span><span class="n">dive_model</span><span class="o">=</span><span class="s2">&quot;unimodal&quot;</span><span class="p">,</span> <span class="n">descent_crit_q</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                            <span class="n">ascent_crit_q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">knot_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">tdrX</span><span class="o">.</span><span class="n">calibrate</span><span class="p">(</span><span class="n">zoc_method</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dive_thr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">P</span><span class="p">,</span>
                   <span class="n">depth_bounds</span><span class="o">=</span><span class="n">DB</span><span class="p">,</span> <span class="n">descent_crit_q</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">knot_factor</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">tdrX</span><span class="o">.</span><span class="n">calibrate_speed</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/skdiveMove_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skdiveMove 0.1.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">tdr</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Sebastian Luque.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.1.2.
    </div>
  </body>
</html>